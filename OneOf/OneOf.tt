<#@ template debug="true" hostspecific="true" language="C#" #>
<#@ assembly name="System.Core" #>
<#@ assembly name="Microsoft.CSharp" #>
<#@ import namespace="System.IO" #>
<#@ import namespace="System.Linq" #>
<#@ import namespace="System.Text" #>
<#@ import namespace="System.Collections.Generic" #>
<#@ output extension=".cs" #>
<# 
GenerateClasses(); 
#>
<#+
void GenerateClasses()
{
	WriteLine("// ===========================================================================");
	WriteLine("// Generated by {0}", System.IO.Path.GetFileName(Host.TemplateFile));
	WriteLine("// ===========================================================================");
	WriteLine("");
	WriteLine("using System;");
	WriteLine("using Newtonsoft.Json;");
	WriteLine("");
	WriteLine("namespace OneOf");
	using(var indent1 = new Indent(this))
	{
		for (var i = 1; i < 10; i++)
			WriteType("OneOf", true, i);

		for (var i = 1; i < 10; i++)
			WriteType("OneOfBase", false, i);
	}
}

void WriteType(string typeName, bool isStruct, int countOfgenericParams) 
{
	var genericArg = string.Join(", ", Enumerable.Range(0, countOfgenericParams).Select(e => "T" + e));
	var structOrClass = isStruct ? "struct" : "class";

    WriteLine("[JsonConverter(typeof(OneOfJsonConverter))]");
	WriteLine($"public {structOrClass} {typeName}<{genericArg}> : IOneOf");
	using(var indent1 = new Indent(this))
	{
		WriteLine("readonly object value;");
		WriteLine("readonly int index;");

		// =============== Constructors
	    
		WriteLine("");
		WriteLine($"{typeName}(object value, int index) {{ this.value = value; this.index = index; }}");

		if (!isStruct)
		{
			WriteLine("");
			WriteLine($"protected {typeName}()");
			using(var indent2 = new Indent(this))
			{
				WriteLine("this.value = this;");
				WriteLine("");

				for (var j = 0; j < countOfgenericParams; j++)
				{
					WriteLine($"if (this is T{j}) this.index = {j};");
				}
			}
		}

		// =============== IOneOf implementation

		WriteLine("");
		WriteLine("object IOneOf.Value => value;");

		// =============== GetT

		WriteLine("");
		WriteLine("T Get<T>(int index)");
		using(var indent2 = new Indent(this))
		{
			WriteLine("if (index != this.index)");
			using(var indent3 = new Indent(this))
			{
				WriteLine("throw new InvalidOperationException($\"Cannot return as T{index} as result is T{this.index}\");");
			}
			WriteLine("return (T)value;");
		}

		// =============== IsT

		WriteLine("");
		for(var parmIndex = 0; parmIndex < countOfgenericParams; parmIndex ++)
		{
			WriteLine($"public bool IsT{parmIndex} => index == {parmIndex};");
		}

		WriteLine("");
		WriteLine($"public bool IsT<T>()");
		using(var indent2 = new Indent(this))
		{
			WriteLine("// quick path for when value non-null and correct type");
			WriteLine($"if (this.value is T) return true;");
			WriteLine("");

			WriteLine("// slower path for when value null, or wrong type");
			for(var parmIndex = 0; parmIndex < countOfgenericParams; parmIndex ++)
			{
				WriteLine($"if (IsT{parmIndex} && typeof(T) == typeof(T{parmIndex})) return true;");
			}

			WriteLine("");
			WriteLine("return false;");
		}

		// =============== AsT

		WriteLine("");
		for(var parmIndex = 0; parmIndex < countOfgenericParams; parmIndex ++)
		{
			WriteLine($"public T{parmIndex} AsT{parmIndex} => Get<T{parmIndex}>({parmIndex});"); 
		}

		WriteLine("");
		WriteLine($"public T AsT<T>()");
		using(var indent2 = new Indent(this))
		{
			WriteLine("// quick path for when value non-null and correct type");
			WriteLine($"if (this.value is T) return (T)this.value;");
			WriteLine("");

			WriteLine("// slower path for when value null, or wrong type");
			for(var parmIndex = 0; parmIndex < countOfgenericParams; parmIndex ++)
			{
				WriteLine($"if (IsT{parmIndex} && typeof(T) == typeof(T{parmIndex})) return (T)value;");
			}

			WriteLine("");
			WriteLine("throw new InvalidOperationException();");
		}

		// =============== implicit conversion to T

		WriteLine("");
		for(var parmIndex = 0; parmIndex < countOfgenericParams; parmIndex ++)
		{
			WriteLine($"public static implicit operator {typeName}<{genericArg}>(T{parmIndex} t) => new {typeName}<{genericArg}>(t, {parmIndex});"); 
		}

		// =============== Switch

		var switchArgList = string.Join(", ", Enumerable.Range(0, countOfgenericParams).Select(e => "Action<T" + e + "> f" + e + " = null"));

		WriteLine("");
	    WriteLine($"public void Switch({switchArgList}, Action otherwise = null)");
		using(var indent2 = new Indent(this))
		{
			for (var j = 0; j < countOfgenericParams; j++)
			{
				WriteLine("if (this.IsT{0} && f{0} != null) {{ f{0}(this.AsT{0}); return; }}", j);
			}

			WriteLine("");
		    WriteLine("if (otherwise != null) { otherwise(); return; }");

			WriteLine("");
			WriteLine("throw new InvalidOperationException();");
		}

		// =============== Match

		var matchArgList = string.Join(", ", Enumerable.Range(0, countOfgenericParams).Select(e => "Func<T" + e + ", TResult> f" + e + " = null"));

		WriteLine("");
	    WriteLine($"public TResult Match<TResult>({matchArgList}, Func<TResult> otherwise = null)");
		using(var indent2 = new Indent(this))
		{
			for (var j = 0; j < countOfgenericParams; j++)
			{
				WriteLine($"if (this.IsT{j} && f{j} != null) return f{j}(this.AsT{j});");
			}

			WriteLine("");
		    WriteLine("if (otherwise != null) return otherwise();");

			WriteLine("");
	    	WriteLine("throw new InvalidOperationException();");
		}

		// =============== object overrides

		WriteLine("");
		WriteLine("public override bool Equals(object obj)");
		using(var indent2 = new Indent(this))
		{
            WriteLine("if (ReferenceEquals(null, obj)) return false;");
            WriteLine($"if (!(obj is {typeName}<{genericArg}>)) return false;");
			WriteLine("");
            WriteLine($"var other = ({typeName}<{genericArg}>)obj;");
            WriteLine("return index == other.index && Equals(value, other.value);");
		}

		WriteLine("");
		WriteLine("public override int GetHashCode() => unchecked((value?.GetHashCode() ?? 0) * 397 ^ index);");

		WriteLine("");
		WriteLine("public override string ToString() => (value?.ToString() ?? \"\");");

	}

	WriteLine("");
}

class Indent: IDisposable
{
	GeneratedTextTransformation textTransformation;

	public Indent(GeneratedTextTransformation textTransformation)
	{
		this.textTransformation = textTransformation;

		textTransformation.WriteLine("{");
		textTransformation.PushIndent("    ");
	}

	public void Dispose()
	{
		textTransformation.PopIndent();
		textTransformation.WriteLine("}");
	}
}

#>
